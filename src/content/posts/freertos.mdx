---
title: '初识FreeRTOS'
description: '来聊聊FreeRTOS的基本概念'
pubDate: 2025-12-08
tags: ['FreeRTOS', '操作系统']
---

先来看看FreeRTOS的官方介绍

> FreeRTOS是市场领先的嵌入式系统RTOS，支持40多个处理器架构，内存占用空间小，执行时间快，RTOS功能和尖端RTOS功能和库，包括对称多处理（SMP）、支持IPv6的线程安全TCP堆栈，以及与云服务无缝集成。它是开源的，并积极支持和维护。

简单来说，FreeRTOS包含以下几个特点
- 轻量级：内核代码仅几KB，内存占用极小。
- 可裁剪：可按需启用，禁用功能。类似node.js应用开发中的按需导入功能。
- 抢占式调度：高优先级任务可抢占低优先级任务执行，该操作可以保证实时性。
- 开源免费

### 按需启用功能的配置方法

编辑项目中的配置文件 **_FreeRTOSConfig.h_**

```h
#ifndef FREERTOS_CONFIG_H
#define FREERTOS_CONFIG_H

/* -------------------------- 基础内核必配 -------------------------- */
#define configUSE_PREEMPTION            1U  // 启用抢占式调度
#define configMAX_PRIORITIES            3U  // 仅需3个优先级（0=空闲，1=LED，2=UART）
#define configMINIMAL_STACK_SIZE        128U// 空闲任务栈128字（32位=512字节）
#define configTICK_RATE_HZ              1000U// 1ms节拍
#define configCPU_CLOCK_HZ              (SystemCoreClock) // STM32系统时钟（自动匹配）
#define configSTACK_DEPTH_TYPE         uint16_t // 栈大小类型（节省内存）
#define configMAX_TASK_NAME_LEN         8U  // 任务名最大长度（缩短节省内存）

/* -------------------------- 任务管理裁剪 -------------------------- */
#define configUSE_TASK_NOTIFICATIONS    1U  // 启用任务通知（替代信号量）
#define INCLUDE_vTaskDelete            0U  // 禁用任务删除（任务创建后不删除）
#define INCLUDE_vTaskSuspend           0U  // 禁用任务挂起
#define INCLUDE_vTaskDelay             1U  // 仅保留延时API
#define INCLUDE_xTaskGetSchedulerState 0U  // 禁用调度器状态查询

/* -------------------------- 同步通信裁剪 -------------------------- */
#define configUSE_QUEUES               0U  // 禁用队列（用任务通知替代）
#define configUSE_SEMAPHORES           0U  // 禁用信号量
#define configUSE_MUTEXES              0U  // 无共享资源，禁用互斥锁
#define configUSE_EVENT_GROUPS         0U  // 禁用事件组

/* -------------------------- 定时器裁剪 -------------------------- */
#define configUSE_TIMERS               0U  // 禁用软件定时器（用硬件定时器）

/* -------------------------- 内存管理裁剪 -------------------------- */
#define configSUPPORT_DYNAMIC_ALLOCATION 1U // 启用动态分配（简化开发）
#define configSUPPORT_STATIC_ALLOCATION  0U // 禁用静态分配
#define configTOTAL_HEAP_SIZE          (1024U * 2U) // 堆总大小2KB（按需缩减）

/* -------------------------- 中断管理 -------------------------- */
#define configMAX_SYSCALL_INTERRUPT_PRIORITY 5U // STM32：优先级5及以下可调用API
#define configUSE_PORT_OPTIMISED_TASK_SELECTION 1U // 启用硬件优化的任务选择（STM32支持）

/* -------------------------- 调试裁剪 -------------------------- */
#define configASSERT( x ) if( ( x ) == 0 ) { taskDISABLE_INTERRUPTS(); for( ;; ); }
#define configUSE_IDLE_HOOK            0U  // 禁用空闲钩子
#define configUSE_TICK_HOOK            0U  // 禁用节拍钩子

/* -------------------------- 无需修改的默认宏 -------------------------- */
#include <stdint.h>
#define portCHAR        char
#define portFLOAT       float
#define portDOUBLE      double
#define portLONG        long
#define portSHORT       short
#define portSTACK_TYPE  uint32_t
#define portBASE_TYPE   long

#endif /* FREERTOS_CONFIG_H */
```

_官方文档 https://www.freertos.org/Documentation/02-Kernel/03-Supported-devices/02-Customization_

### 实时调度
与非实时操作系统最大的不同是，实时操作系统的首要目标是满足任务的时间约束，即保证任务在规定的截止时间（Deadline）内完成执行，其次才考虑系统吞吐量、资源利用率等指标。

另外，实时操作系统并不是一定能保证任务在截止时间完成，他也需要程序编写者所做的动作是切实可满足的。

> This basic form of real-time scheduling isn't magic - it can't slow down or speed up time - the application writer must ensure their timing constraints are feasible to meet with their selected task prioritisation.

### 核心概念
1. 任务（Task）
- 操作系统的最小执行单元，每个任务独立运行，有自己的栈空间和执行函数。
- 任务状态：运行、就绪、阻塞、挂起。
- 核心 API：
  - xTaskCreate()：创建任务（动态分配栈）。
  - vTaskDelete()：删除任务。
  - vTaskDelay()：任务延时（阻塞状态）。
  - vTaskPrioritySet()：修改任务优先级。
2. 调度器（Scheduler）
- 负责任务的切换，FreeRTOS 默认采用抢占式优先级调度，也支持协作式调度。
- 核心API
  - vTaskStartScheduler()：启动调度器（任务开始执行）。

### FreeRTOS源代码结构解读
```shell
+-tools            亚马逊相关文件
|
+-FreeRTOS-Plus    主要是FreeRTOS的一些生态文件
|
+-FreeRTOS         FreeRTOS核心目录
    |
    +-Demo      官方的示例应用
    |
    +-Source    FreeRTOS源代码目录
        |
        +-include   头文件
        |
        +-tasks.c   -+
        |            |
        +-queue.c    +- FreeRTOS核心代码
        |            |
        +-list.c    -+
        |
        +-...
```
